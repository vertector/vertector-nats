# NATS Server Configuration with TLS/SSL
# For production deployment with encrypted connections

# Server identity
server_name: nats-prod-01

# Network configuration
host: 0.0.0.0
port: 4222

# HTTP monitoring endpoint
http_port: 8222

# TLS Configuration
tls {
    # Server certificate and key
    cert_file: "/etc/nats/tls/server-cert.pem"
    key_file:  "/etc/nats/tls/server-key.pem"

    # CA certificate for client verification (mutual TLS)
    ca_file:   "/etc/nats/tls/ca-cert.pem"

    # Verify client certificates (mutual TLS)
    verify: true

    # Require clients to present certificates
    verify_and_map: true

    # Timeout for TLS handshake
    timeout: 5

    # Allowed cipher suites (strong ciphers only)
    cipher_suites: [
        "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",
        "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256",
        "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256"
    ]

    # Minimum TLS version
    curve_preferences: [
        "CurveP384",
        "CurveP256"
    ]
}

# JetStream configuration
jetstream {
    # Storage directory
    store_dir: "/data/jetstream"

    # Maximum storage size (100GB)
    max_memory_store: 1GB
    max_file_store: 100GB

    # Domain for JetStream federation
    domain: "production"
}

# Limits
max_connections: 10000
max_control_line: 4096
max_payload: 2MB
max_pending: 64MB

# Write deadline (how long server will wait to write to client)
write_deadline: "10s"

# Ping interval
ping_interval: "2m"
ping_max: 3

# Authentication (user/password)
authorization {
    users = [
        # Academic Schedule Service
        {
            user: "schedule_service"
            password: "$2a$11$YOUR_BCRYPT_HASHED_PASSWORD_HERE"
            permissions: {
                publish: ["academic.>", "_INBOX.>"]
                subscribe: ["academic.>", "_INBOX.>"]
            }
        },
        # Notes Service
        {
            user: "notes_service"
            password: "$2a$11$YOUR_BCRYPT_HASHED_PASSWORD_HERE"
            permissions: {
                publish: ["notes.>", "_INBOX.>"]
                subscribe: ["academic.>", "notes.>", "_INBOX.>"]
            }
        },
        # Admin user
        {
            user: "admin"
            password: "$2a$11$YOUR_BCRYPT_HASHED_PASSWORD_HERE"
            permissions: {
                publish: ">"
                subscribe: ">"
            }
        }
    ]

    # Timeout for authentication
    timeout: 2.0
}

# Logging
log_file: "/var/log/nats/nats-server.log"
log_size_limit: 100MB
max_traced_msg_len: 4096

# Debug and trace (disable in production)
debug: false
trace: false
logtime: true

# Clustering (for multi-node setup)
cluster {
    # Cluster name
    name: "nats-prod-cluster"

    # Listen for cluster connections
    listen: 0.0.0.0:6222

    # TLS for cluster connections
    tls {
        cert_file: "/etc/nats/tls/server-cert.pem"
        key_file:  "/etc/nats/tls/server-key.pem"
        ca_file:   "/etc/nats/tls/ca-cert.pem"
        verify: true
        timeout: 5
    }

    # Routes to other servers (update with actual server addresses)
    routes = [
        nats://nats-prod-01:6222
        nats://nats-prod-02:6222
        nats://nats-prod-03:6222
    ]

    # Cluster authorization
    authorization {
        user: "cluster_user"
        password: "$2a$11$YOUR_BCRYPT_HASHED_PASSWORD_HERE"
        timeout: 2.0
    }
}

# System account for monitoring
system_account: "SYS"

# Accounts (optional - for multi-tenancy)
accounts {
    # System account
    SYS: {
        users: [
            { user: "sys", password: "$2a$11$YOUR_BCRYPT_HASHED_PASSWORD_HERE" }
        ]
    }

    # Application account
    APP: {
        jetstream: enabled
        users: [
            { user: "schedule_service", password: "$2a$11$YOUR_BCRYPT_HASHED_PASSWORD_HERE" },
            { user: "notes_service", password: "$2a$11$YOUR_BCRYPT_HASHED_PASSWORD_HERE" }
        ]
    }
}

# Resolve addresses
resolver: NONE

# PID file
pid_file: "/var/run/nats/nats-server.pid"
